generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// 供应商
model Vendor {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique
  remark               String?
  products             Product[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  // stockIns   StockIn[]
  productJoinStockIns  ProductJoinStockIn[]
  productJoinStockOuts ProductJoinStockOut[]
}

// 进货单的状态
enum StockInStatus {
  PENDING // 处理中
  COMPLETED // 完成
}

// 进货
model StockIn {
  id                 Int                  @id @default(autoincrement())
  remark             String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  deletedAt          DateTime?
  totalCost          Int                  @db.UnsignedMediumInt // 订单总价
  productJoinStockIn ProductJoinStockIn[]
  status             StockInStatus        @default(PENDING) // 进货单的状态
  completedAt        DateTime?
}

// 产品进货单中间表
model ProductJoinStockIn {
  id          Int          @id @default(autoincrement())
  stockInId   Int
  stockIn     StockIn      @relation(fields: [stockInId], references: [id])
  productId   Int
  product     Product      @relation(fields: [productId], references: [id])
  cost        Int // 售价
  count       Int // 数量
  historyCost HistoryCost?
  vendorId    Int
  vendor      Vendor?      @relation(fields: [vendorId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  @@unique([stockInId, productId, cost])
}

// 商品
model Product {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique
  img                 String?
  vendorId            Int
  remark              String?
  balance             Int?                  @default(0) @db.UnsignedSmallInt
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?
  // imports  ImportProduct[]
  Vendor              Vendor?               @relation(fields: [vendorId], references: [id])
  // StockIn   StockIn[]
  latestPrice         Int? // 售价,只有进库后才有
  latestCost          Int? // 成本价,只有进库后才有
  productCode         String?               @unique @db.VarChar(20) // 只有进库后才有
  productJoinStockIn  ProductJoinStockIn[] // 进货中间表
  historyCost         HistoryCost[]         @relation("HistoryCostProduct")
  productJoinStockOut ProductJoinStockOut[] // 出货中间表
  stockOutPending     Int                   @default(0) @db.UnsignedSmallInt // 出货中产品
  stockInPending      Int                   @default(0) @db.UnsignedSmallInt // 进货中产品
  shelfPrice          Int // 货架价

  @@index([vendorId], map: "Product_brandId_fkey")
}

// 用户
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  username  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  password  String
  avatar    String?
}

// 历史成本
model HistoryCost {
  id                   Int                @id @default(autoincrement())
  productJoinStockInId Int                @unique
  productJoinStockIn   ProductJoinStockIn @relation(fields: [productJoinStockInId], references: [id], onDelete: Cascade)
  productId            Int
  Product              Product            @relation("HistoryCostProduct", fields: [productId], references: [id])
  value                Int                @db.UnsignedMediumInt
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  deletedAt            DateTime?
}

// 出货表
model StockOut {
  id                  Int                   @id @default(autoincrement())
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  deletedAt           DateTime?
  totalPrice          Int                   @db.UnsignedMediumInt
  status              StockInStatus         @default(PENDING)
  completedAt         DateTime?
  remark              String?
  productJoinStockOut ProductJoinStockOut[]
}

model ProductJoinStockOut {
  id         Int       @id @default(autoincrement())
  productId  Int
  product    Product   @relation(fields: [productId], references: [id])
  stockOutId Int
  stockOut   StockOut  @relation(fields: [stockOutId], references: [id], onDelete: Cascade)
  price      Int // 售价
  count      Int // 数量
  vendorId   Int
  vendor     Vendor?   @relation(fields: [vendorId], references: [id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  @@unique([stockOutId, productId, count])
}
